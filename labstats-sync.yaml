AWSTemplateFormatVersion: 2010-09-09
Description: Scheduled LabStats sync.
Parameters:
  LambdaRate:
    Description: The rate(frequency) that determines when CloudWatch Events runs the rule that triggers the Lambda function.
    Default: rate(1 minute)
    AllowedValues:
      - rate(1 minute)
      - rate(10 minutes)
      - rate(60 minutes)
    Type: String
  LabStatsBucket:
    Description: S3 Lambda output.
    Type: String
  CodeBucket:
    Description: S3 Code bucket.
    Type: String
  CodeKey:
    Description: S3 Code bucket key.
    Type: String
  LabStatsApiKey:
    Description: LabStats API Key.
    Type: String
  ApplicationName:
    Default: LabStats Sync
    Type: String
Resources:
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties: 
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: Lambda
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
      - PolicyName: S3Access
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - 's3:ListBucket'
            Resource: 
            - !Sub 'arn:aws:s3:::${LabStatsBucket}' 
            - !Sub 'arn:aws:s3:::${CodeBucket}'
          - Effect: Allow
            Action:
            - 's3:GetObject'
            - 's3:PutObject'
            Resource:
            - !Sub 'arn:aws:s3:::${LabStatsBucket}/*'
            - !Sub 'arn:aws:s3:::${CodeBucket}/*'   
      RoleName: LabStats Sync Role
  LambdaSchedule:
    Type: AWS::Events::Rule
    Properties:
      Description: A schedule for the Lambda function.
      ScheduleExpression: !Ref LambdaRate
      State: ENABLED
      Targets:
        - Arn: !Sub ${LambdaFunction.Arn}
          Id: LambdaSchedule
  LambdaSchedulePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub ${LambdaFunction.Arn}
      Principal: events.amazonaws.com
      SourceArn: !Sub ${LambdaSchedule.Arn}
  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        CodeBucket: !Ref CodeBucket
        S3Key: !Ref CodeKey
      FunctionName: LabStatsSync
      Handler: edu.sydneyuni.myuni.LabStatsSync
      MemorySize: 128
      Timeout: 120
      Role: !Sub ${LambdaExecutionRole.Arn}
      Runtime: java8
      Environment:
        S3_BUCKET: !Ref LabStatsBucket
        LABSTATS_API_KEY: !Ref LabStatsApiKey
